# åç«¯å¼€å‘ç¯å¢ƒDockerfile - ä¼˜åŒ–å¼€å‘ä½“éªŒ
FROM python:3.11-slim AS base

ENV PYTHONDONTWRITEBYTECODE=1 
ENV PYTHONUNBUFFERED=1 
ENV PIP_NO_CACHE_DIR=1

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–å’Œå¼€å‘å·¥å…·
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libmariadb-dev-compat \
    libmariadb-dev \
    curl \
    git \
    procps \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…Pythonä¾èµ–
COPY backend/requirements.txt ./requirements.txt

# å®‰è£…å¼€å‘ä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir \
    debugpy \
    watchfiles \
    ipdb \
    pytest \
    pytest-cov \
    black \
    flake8

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app/backend

# è®¾ç½®Flaskç¯å¢ƒå˜é‡
ENV FLASK_APP=app:create_app
ENV FLASK_ENV=development
ENV FLASK_DEBUG=1

# æš´éœ²ç«¯å£
EXPOSE 8000 5678

# åˆ›å»ºå¯åŠ¨è„šæœ¬ä»¥æ”¯æŒè°ƒè¯•
RUN echo '#!/bin/bash\n\
if [ "$FLASK_DEBUG_MODE" = "remote" ]; then\n\
    echo "ğŸ› Starting Flask with remote debugging..."\n\
    python -m debugpy --listen 0.0.0.0:5678 --wait-for-client -m flask run --debug --host=0.0.0.0 --port=8000\n\
else\n\
    echo "ğŸš€ Starting Flask in development mode..."\n\
    flask run --debug --host=0.0.0.0 --port=8000\n\
fi' > /app/start-dev.sh && chmod +x /app/start-dev.sh

# å¼€å‘ç¯å¢ƒå¯åŠ¨å‘½ä»¤ï¼ˆå¯åœ¨docker-composeä¸­è¦†ç›–ï¼‰
CMD ["/app/start-dev.sh"]