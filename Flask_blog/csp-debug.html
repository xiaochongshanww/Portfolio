<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSP调试工具</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .test-item { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .log { height: 200px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="debug-panel">
        <h1>🛡️ CSP调试工具</h1>
        <p>此工具帮助调试Content Security Policy配置，检测被阻止的资源加载。</p>
        
        <div class="test-item">
            <h3>📊 当前CSP策略</h3>
            <pre id="current-csp">检测中...</pre>
        </div>
        
        <div class="test-item">
            <h3>🧪 资源加载测试</h3>
            <button onclick="testExternalResources()">开始测试</button>
            <div id="test-results"></div>
        </div>
        
        <div class="test-item">
            <h3>📝 CSP违规日志</h3>
            <button onclick="clearLog()">清空日志</button>
            <div id="csp-log" class="log">等待CSP违规事件...</div>
        </div>
        
        <div class="test-item">
            <h3>🔧 推荐的CSP配置</h3>
            <pre id="recommended-csp">
# 生产环境推荐CSP配置
Content-Security-Policy: "
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval'
               https://unpkg.com
               https://cdnjs.cloudflare.com  
               https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline'
              https://unpkg.com
              https://cdnjs.cloudflare.com
              https://cdn.jsdelivr.net
              https://fonts.googleapis.com;
    img-src 'self' data: https: blob:;
    font-src 'self' data:
             https://unpkg.com
             https://fonts.gstatic.com
             https://cdnjs.cloudflare.com;
    connect-src 'self' https://api.github.com;
    media-src 'self' data: blob:;
    object-src 'none';
    base-uri 'self';
    frame-ancestors 'self';
    form-action 'self';
"
            </pre>
        </div>
    </div>

    <script>
        // 检测当前CSP策略
        function detectCurrentCSP() {
            const metaCSP = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            const headerCSP = 'CSP通常通过HTTP头设置，无法从JavaScript直接读取';
            
            document.getElementById('current-csp').textContent = metaCSP 
                ? metaCSP.content 
                : headerCSP;
        }
        
        // 测试外部资源加载
        function testExternalResources() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p>🔄 正在测试...</p>';
            
            const tests = [
                {
                    name: 'Vditor CDN (unpkg.com)',
                    type: 'script',
                    url: 'https://unpkg.com/vditor@3.11.1/dist/js/i18n/zh_CN.js'
                },
                {
                    name: 'TinyMCE CDN (cdnjs.cloudflare.com)',
                    type: 'script', 
                    url: 'https://cdnjs.cloudflare.com/ajax/libs/tinymce/7.4.1/tinymce.min.js'
                },
                {
                    name: 'jsdelivr CDN',
                    type: 'script',
                    url: 'https://cdn.jsdelivr.net/npm/tinymce@7/tinymce.min.js'
                },
                {
                    name: 'Google Fonts CSS',
                    type: 'link',
                    url: 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap'
                },
                {
                    name: '示例图片 (HTTPS)',
                    type: 'img',
                    url: 'https://picsum.photos/100/100'
                }
            ];
            
            let results = [];
            let completed = 0;
            
            tests.forEach(test => {
                const element = test.type === 'script' ? document.createElement('script')
                             : test.type === 'link' ? document.createElement('link')
                             : document.createElement('img');
                
                element.onload = () => {
                    results.push(`<div class="status success">✅ ${test.name}: 加载成功</div>`);
                    completed++;
                    if (completed === tests.length) updateResults();
                };
                
                element.onerror = () => {
                    results.push(`<div class="status error">❌ ${test.name}: 加载失败 (可能被CSP阻止)</div>`);
                    completed++;
                    if (completed === tests.length) updateResults();
                };
                
                if (test.type === 'script') {
                    element.src = test.url;
                } else if (test.type === 'link') {
                    element.rel = 'stylesheet';
                    element.href = test.url;
                } else {
                    element.src = test.url;
                    element.style.display = 'none';
                }
                
                document.head.appendChild(element);
            });
            
            function updateResults() {
                resultsDiv.innerHTML = results.join('');
            }
        }
        
        // 监听CSP违规事件
        document.addEventListener('securitypolicyviolation', (e) => {
            const logDiv = document.getElementById('csp-log');
            const timestamp = new Date().toLocaleTimeString();
            const violation = `[${timestamp}] CSP违规: ${e.violatedDirective} - ${e.blockedURI}\n`;
            logDiv.textContent += violation;
            logDiv.scrollTop = logDiv.scrollHeight;
        });
        
        function clearLog() {
            document.getElementById('csp-log').textContent = '等待CSP违规事件...\n';
        }
        
        // 页面加载时检测CSP
        detectCurrentCSP();
        
        console.log('🛡️ CSP调试工具已加载');
        console.log('💡 打开浏览器开发者工具的Console和Network标签页来查看更多详细信息');
    </script>
</body>
</html>