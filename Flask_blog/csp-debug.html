<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSPè°ƒè¯•å·¥å…·</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .test-item { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .log { height: 200px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="debug-panel">
        <h1>ğŸ›¡ï¸ CSPè°ƒè¯•å·¥å…·</h1>
        <p>æ­¤å·¥å…·å¸®åŠ©è°ƒè¯•Content Security Policyé…ç½®ï¼Œæ£€æµ‹è¢«é˜»æ­¢çš„èµ„æºåŠ è½½ã€‚</p>
        
        <div class="test-item">
            <h3>ğŸ“Š å½“å‰CSPç­–ç•¥</h3>
            <pre id="current-csp">æ£€æµ‹ä¸­...</pre>
        </div>
        
        <div class="test-item">
            <h3>ğŸ§ª èµ„æºåŠ è½½æµ‹è¯•</h3>
            <button onclick="testExternalResources()">å¼€å§‹æµ‹è¯•</button>
            <div id="test-results"></div>
        </div>
        
        <div class="test-item">
            <h3>ğŸ“ CSPè¿è§„æ—¥å¿—</h3>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="csp-log" class="log">ç­‰å¾…CSPè¿è§„äº‹ä»¶...</div>
        </div>
        
        <div class="test-item">
            <h3>ğŸ”§ æ¨èçš„CSPé…ç½®</h3>
            <pre id="recommended-csp">
# ç”Ÿäº§ç¯å¢ƒæ¨èCSPé…ç½®
Content-Security-Policy: "
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval'
               https://unpkg.com
               https://cdnjs.cloudflare.com  
               https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline'
              https://unpkg.com
              https://cdnjs.cloudflare.com
              https://cdn.jsdelivr.net
              https://fonts.googleapis.com;
    img-src 'self' data: https: blob:;
    font-src 'self' data:
             https://unpkg.com
             https://fonts.gstatic.com
             https://cdnjs.cloudflare.com;
    connect-src 'self' https://api.github.com;
    media-src 'self' data: blob:;
    object-src 'none';
    base-uri 'self';
    frame-ancestors 'self';
    form-action 'self';
"
            </pre>
        </div>
    </div>

    <script>
        // æ£€æµ‹å½“å‰CSPç­–ç•¥
        function detectCurrentCSP() {
            const metaCSP = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            const headerCSP = 'CSPé€šå¸¸é€šè¿‡HTTPå¤´è®¾ç½®ï¼Œæ— æ³•ä»JavaScriptç›´æ¥è¯»å–';
            
            document.getElementById('current-csp').textContent = metaCSP 
                ? metaCSP.content 
                : headerCSP;
        }
        
        // æµ‹è¯•å¤–éƒ¨èµ„æºåŠ è½½
        function testExternalResources() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p>ğŸ”„ æ­£åœ¨æµ‹è¯•...</p>';
            
            const tests = [
                {
                    name: 'Vditor CDN (unpkg.com)',
                    type: 'script',
                    url: 'https://unpkg.com/vditor@3.11.1/dist/js/i18n/zh_CN.js'
                },
                {
                    name: 'TinyMCE CDN (cdnjs.cloudflare.com)',
                    type: 'script', 
                    url: 'https://cdnjs.cloudflare.com/ajax/libs/tinymce/7.4.1/tinymce.min.js'
                },
                {
                    name: 'jsdelivr CDN',
                    type: 'script',
                    url: 'https://cdn.jsdelivr.net/npm/tinymce@7/tinymce.min.js'
                },
                {
                    name: 'Google Fonts CSS',
                    type: 'link',
                    url: 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap'
                },
                {
                    name: 'ç¤ºä¾‹å›¾ç‰‡ (HTTPS)',
                    type: 'img',
                    url: 'https://picsum.photos/100/100'
                }
            ];
            
            let results = [];
            let completed = 0;
            
            tests.forEach(test => {
                const element = test.type === 'script' ? document.createElement('script')
                             : test.type === 'link' ? document.createElement('link')
                             : document.createElement('img');
                
                element.onload = () => {
                    results.push(`<div class="status success">âœ… ${test.name}: åŠ è½½æˆåŠŸ</div>`);
                    completed++;
                    if (completed === tests.length) updateResults();
                };
                
                element.onerror = () => {
                    results.push(`<div class="status error">âŒ ${test.name}: åŠ è½½å¤±è´¥ (å¯èƒ½è¢«CSPé˜»æ­¢)</div>`);
                    completed++;
                    if (completed === tests.length) updateResults();
                };
                
                if (test.type === 'script') {
                    element.src = test.url;
                } else if (test.type === 'link') {
                    element.rel = 'stylesheet';
                    element.href = test.url;
                } else {
                    element.src = test.url;
                    element.style.display = 'none';
                }
                
                document.head.appendChild(element);
            });
            
            function updateResults() {
                resultsDiv.innerHTML = results.join('');
            }
        }
        
        // ç›‘å¬CSPè¿è§„äº‹ä»¶
        document.addEventListener('securitypolicyviolation', (e) => {
            const logDiv = document.getElementById('csp-log');
            const timestamp = new Date().toLocaleTimeString();
            const violation = `[${timestamp}] CSPè¿è§„: ${e.violatedDirective} - ${e.blockedURI}\n`;
            logDiv.textContent += violation;
            logDiv.scrollTop = logDiv.scrollHeight;
        });
        
        function clearLog() {
            document.getElementById('csp-log').textContent = 'ç­‰å¾…CSPè¿è§„äº‹ä»¶...\n';
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹CSP
        detectCurrentCSP();
        
        console.log('ğŸ›¡ï¸ CSPè°ƒè¯•å·¥å…·å·²åŠ è½½');
        console.log('ğŸ’¡ æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„Consoleå’ŒNetworkæ ‡ç­¾é¡µæ¥æŸ¥çœ‹æ›´å¤šè¯¦ç»†ä¿¡æ¯');
    </script>
</body>
</html>