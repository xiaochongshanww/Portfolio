# 一键部署指导

> 适用于本项目生产/预生产环境的快速落地。基于 Docker Compose，整合后端 (Flask + Gunicorn)、前端 (Vite 构建 + Nginx)、MySQL、Redis、MeiliSearch、Celery Worker / Beat 以及统一反向代理。

---
## 1. 架构概览
```
                ┌───────────── gateway (nginx) ─────────────┐
Browser ⇄ 80 →  │  /          /api → backend (gunicorn)     │
                │  /uploads → 卷 (只读)                     │
                └──────────────┬───────────┬───────────────┘
                               │           │
                         Celery Worker   Celery Beat
                               │           │
 backend (Flask) ─┬── Redis (broker/cache/限流) ──┐
                  │                                │
                  └── MySQL (数据)                  └── MeiliSearch (搜索索引)
                  └── uploads 卷 (媒体文件)
```
数据持久化：`mysqldata`、`meilidata`、`uploads`。

---
## 2. 目录与核心文件
| 文件 | 作用 |
|------|------|
| `docker-compose.prod.yml` | 生产编排定义 |
| `Dockerfile.backend` | 后端镜像（含自动迁移入口脚本） |
| `Dockerfile.frontend` | 前端构建 + Nginx 静态镜像 |
| `backend/entrypoint.sh` | 启动时迁移 & 可选重建索引 |
| `deploy/nginx.conf` | 网关 Nginx，前端 + API 反代 + 上传 |
| `deploy/deploy.ps1` | Windows 一键部署脚本（含健康探测） |
| `.env.example` | 环境变量示例（复制为 `.env` 使用） |

---
## 3. 准备
1. 安装 Docker / Docker Compose Plugin
2. 克隆代码仓库
3. 复制环境变量文件：
   ```powershell
   Copy-Item .env.example .env
   ```
4. 修改 `.env` 中的 **JWT_SECRET_KEY**、数据库口令等敏感值。

---
## 4. 快速开始
### 4.1 直接使用脚本
```powershell
pwsh deploy/deploy.ps1           # 首次或更新
pwsh deploy/deploy.ps1 -Rebuild  # 强制重建镜像
pwsh deploy/deploy.ps1 -Pull     # 预拉取基础镜像
```
脚本包含：构建 → 启动 → /api/v1/health 健康探测。

### 4.2 手动操作
```powershell
Copy-Item .env.example .env
# 编辑 .env
docker compose -f docker-compose.prod.yml up -d --build
Invoke-WebRequest http://localhost/api/v1/health | Select-Object -Expand Content
```
访问前端: http://localhost

---
## 5. 环境变量（关键）
| 变量 | 说明 | 典型值 |
|------|------|--------|
| DATABASE_URL | MySQL 连接 | mysql+pymysql://blog:blog@db:3306/blog?charset=utf8mb4 |
| REDIS_URL | Redis | redis://redis:6379/0 |
| MEILISEARCH_URL | 搜索服务 | http://meili:7700 |
| JWT_SECRET_KEY | JWT 密钥 | (自定义强随机) |
| CORS_ORIGINS | 允许源 | * 或 https://your.domain |
| UPLOAD_DIR | 上传目录 | uploads |
| AUTO_MIGRATE | 启动自动迁移 | 1/0 |
| REINDEX_ON_START | 启动时重建索引 | true/false |
| LOG_LEVEL | 后端日志级别 | INFO |
| ENABLE_SCHEDULER | 发布调度器 | true |

> 生产环境不要把敏感变量硬编码在 Git，可使用 CI/CD Secret 注入。

---
## 6. 服务说明
| 服务 | 端口 (宿主) | 说明 |
|------|-------------|------|
| gateway | 80 | 统一入口 + 静态/上传/反代 |
| backend | (内部 8000) | Flask + Gunicorn，多 worker + 线程 |
| celery_worker | - | 异步任务执行 |
| celery_beat | - | 定时任务调度 |
| frontend | (由 gateway 暴露) | 构建后静态文件 |
| db (MySQL 8.4) | 未暴露 | 仅内部网络访问 |
| redis | 未暴露 | Broker / 缓存 / 限流存储 |
| meili | 7700 (可选映射) | 搜索引擎/索引管理 |

---
## 7. 数据卷
| 卷 | 内容 | 备份策略建议 |
|----|------|---------------|
| mysqldata | MySQL 数据文件 | 物理或逻辑 (mysqldump) 日/周策略 |
| meilidata | Meili 索引数据 | 可快照；灾难时可依 DB 重建 |
| uploads | 用户上传媒体 | 定期打包 + 异地复制 |

---
## 8. 常用运维命令
```powershell
# 查看日志
docker compose -f docker-compose.prod.yml logs -f backend

# 进入后端容器
docker compose -f docker-compose.prod.yml exec backend bash

# 手动数据库迁移
docker compose -f docker-compose.prod.yml exec backend flask db upgrade

# 重建搜索索引
docker compose -f docker-compose.prod.yml exec backend python -m scripts.reindex_search

# 调整后端并滚动更新
docker compose -f docker-compose.prod.yml build backend
docker compose -f docker-compose.prod.yml up -d backend

# 停止与清理
docker compose -f docker-compose.prod.yml down
# 删除卷（谨慎）
docker compose -f docker-compose.prod.yml down -v
```

---
## 9. 性能与扩展
- Gunicorn worker 调整：`workers = 2 * CPU + 1`；I/O 密集可换 gevent：`-k gevent --worker-connections 1000`。
- 前端静态资源可迁移至对象存储 + CDN，gateway 仅保留 API。
- Redis 生产开启持久化 (appendonly yes) 并限制绑定 / 密码。
- 可在 gateway 层添加 gzip/brotli（自定义镜像或启用模块）与更细粒度 Cache-Control。

---
## 10. 安全与配置强化
| 方向 | 要点 |
|------|------|
| HTTPS | 使用反向代理或 Ingress (K8s) 加证书 (Let’s Encrypt) |
| 密钥管理 | CI Secret / Vault 注入 JWT & DB 密码 |
| 访问控制 | MeiliSearch 设置 Master Key 仅后端调用 |
| 日志 | 结构化 JSON -> 外部收集 (ELK / Loki) |
| 上传 | 校验 MIME + 限制大小 + 可选病毒扫描 (ClamAV sidecar) |
| 头部安全 | Nginx 增加 HSTS、CSP、Referrer-Policy、Permissions-Policy |

---
## 11. 升级与回滚
1. 拉取新代码 / 切换标签
2. 构建：`docker compose -f docker-compose.prod.yml build backend frontend`
3. 迁移：后端容器自动迁移 (AUTO_MIGRATE=1) 或手动执行
4. 健康检查：`/api/v1/health` 返回 200
5. 回滚：切回旧标签 → 重建旧镜像 → 启动；如涉及降级需手动处理数据库（建议向前兼容迁移脚本）

---
## 12. 备份策略起点 (可与后续 backup 模块整合)
| 项目 | 周期 | 工具 |
|------|------|------|
| MySQL 全量 | 每周 | `mysqldump` 或 物理快照 |
| MySQL 增量 | 每日 | binlog 归档 |
| uploads | 每日打包 | `tar` + 校验和 |
| MeiliSearch | 每周 | dump 或重建脚本 |
| Off-site | 每日同步 | rclone / 云存储 SDK |

---
## 13. 故障排查快速表
| 现象 | 排查点 |
|------|--------|
| 健康接口 5xx | 查看 backend 日志 + 数据库连通性 |
| 前端空白 / 404 | 确认 frontend 构建成功 + gateway 日志 |
| 索引失败 | meili 容器是否正常；`MEILISEARCH_URL` 配置 |
| 迁移未生效 | 是否 AUTO_MIGRATE=1；手动执行 flask db upgrade |
| 上传 415/类型错误 | `ALLOWED_IMAGE_TYPES` 与请求头匹配 |
| 性能过慢 | Gunicorn workers、数据库慢查询、Redis 命中率 |

---
## 14. 下一步扩展建议
- CI/CD：构建镜像 → 推送仓库 → 部署前运行迁移 Job → 健康探针 Gate
- K8s：将 compose 拆分 Deployment/Service/Ingress/Secret/PVC
- 监控：Prometheus 抓取 /metrics + Loki/ELK 日志 + Alertmanager 告警
- 前端：Lighthouse CI 集成性能回归基线
- 安全：增加 WAF / Fail2Ban（若暴露管理接口）

---
## 15. 附：自定义 Gunicorn 例子
在 `docker-compose.prod.yml` backend 中覆写：
```yaml
  backend:
    command: gunicorn -w 6 -k gthread --threads 4 -b 0.0.0.0:8000 app:create_app()
```
或异步：
```yaml
command: gunicorn -w 4 -k gevent --worker-connections 1000 -b 0.0.0.0:8000 app:create_app()
```

---
## 16. 最小验证清单
| 步骤 | 验证 |
|------|------|
| 启动 compose | 所有容器 healthy/running |
| 迁移执行 | 表结构最新，日志含 upgrade 成功 |
| OpenAPI | GET /api/v1/openapi.json 200 |
| 健康检查 | GET /api/v1/health 200 |
| 上传图片 | 成功返回 variants / webp |
| 搜索 | 已发布文章被索引可被检索 |

---
完成后即可稳定运行。如需 CI、K8s Manifest 或日志/监控接入，再单独扩展即可。
