# 测试设计文档

## 1. 引言

本文档基于《测试策略文档》，旨在提供“淘宝价格监控工具”项目的具体测试用例和测试场景，作为测试执行的主要依据。

## 2. 单元测试 (Unit Tests)

### 2.1. `database.py`
| 测试用例 ID | 测试模块 | 测试描述 | 前置条件 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| UT-DB-001 | `init_db` | 测试数据库初始化 | 数据库文件不存在 | 1. 调用 `init_db()` | 1. `monitor.db` 文件被创建。<br>2. `products`, `price_history`, `settings` 三张表被创建。<br>3. `settings` 表包含 `email` 和 `frequency_hours` 的默认值。 |

### 2.2. `scraper.py`
| 测试用例 ID | 测试模块 | 测试描述 | 前置条件 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| UT-SCR-001 | `clean_url` | 测试 URL 清理功能 | - | 1. 输入一个包含多余参数的淘宝 URL。<br>2. 调用 `clean_url()`。 | 返回只包含 `id` 参数的纯净 URL。 |
| UT-SCR-002 | `clean_url` | 测试无效 URL | - | 1. 输入一个非淘宝 URL 或格式错误的 URL。<br>2. 调用 `clean_url()`。 | 返回原始 URL。 |

### 2.3. `notifier.py`
| 测试用例 ID | 测试模块 | 测试描述 | 前置条件 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| UT-NOT-001 | `send_email_notification` | 测试邮件发送功能（使用 Mock） | 环境变量已配置 | 1. 使用 `unittest.mock` 模拟 `smtplib.SMTP_SSL`。<br>2. 调用 `send_email_notification()`。 | 1. `smtplib.SMTP_SSL` 被正确调用。<br>2. 邮件内容（收件人、主题、正文）符合预期格式。 |
| UT-NOT-002 | `send_email_notification` | 测试 SMTP 配置缺失 | 环境变量未配置 | 1. 调用 `send_email_notification()`。 | 1. 函数应记录警告日志。<br>2. 不会抛出异常，程序正常返回。 |

## 3. 集成测试 (Integration Tests)

### 3.1. Flask App 与数据库
| 测试用例 ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- | :--- |
| IT-AD-001 | 添加商品接口 | 测试数据库为空 | 1. POST 请求到 `/add`，携带一个有效的商品 URL。 | 1. 响应状态码为 302 (重定向)。<br>2. 数据库 `products` 表中增加了一条新记录。 |
| IT-AD-002 | 添加重复商品 | 数据库中已存在某商品 | 1. POST 请求到 `/add`，携带一个已存在的 URL。 | 1. 响应状态码为 302。<br>2. 数据库 `products` 表的记录数没有增加。 |
| IT-SET-001 | 更新设置 | - | 1. POST 请求到 `/settings`，携带新的邮箱和频率。 | 1. 响应状态码为 302。<br>2. 数据库 `settings` 表中的 `email` 和 `frequency_hours` 值被更新。 |

## 4. 端到端测试 (End-to-End Tests)

### 4.1. 核心用户流程
| 测试用例 ID | 测试场景 | 前置条件 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- | :--- |
| E2E-MAIN-001 | 完整监控流程 | 1. 测试数据库已初始化。<br>2. 浏览器可访问应用。 | 1. 打开主页。<br>2. 在输入框中输入一个新的淘宝商品 URL，点击“添加”。<br>3. 在商品列表中找到该商品，点击“Scrape”。<br>4. (需要 Mock 价格变动) 等待后台任务执行。<br>5. (需要 Mock 邮件服务) 检查是否收到价格变动邮件。 | 1. 主页成功加载。<br>2. 商品成功添加到列表中，初始状态为“Pending scrape”。<br>3. 点击 Scrape 后，商品名称和价格被成功抓取并更新到 UI。<br>4. 价格变动后，邮件被发送到指定邮箱。 |
| E2E-UI-002 | 查看价格历史 | 某商品已有多条价格历史 | 1. 打开主页。<br>2. 点击该商品所在的行。 | 页面下方出现一个图表，正确显示该商品的历史价格曲线。 |
| E2E-DEL-003 | 删除商品 | 列表中存在一个商品 | 1. 点击该商品对应的“Remove”按钮。 | 1. 页面刷新。<br>2. 该商品从列表中消失。<br>3. 数据库中对应的 `products` 和 `price_history` 记录被删除。 |
